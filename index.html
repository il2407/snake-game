<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Snake Game - Two Levels</title>

    <!-- p5.js libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>

    <!-- Google Fonts -->
    <link
            href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
            rel="stylesheet"
    />

    <!-- Custom CSS (optional) -->
    <style>
        body {
          margin: 0;
          padding: 0;
          font-family: "Press Start 2P", sans-serif;
          background: #000; /* fallback background */
          overflow: hidden; /* prevent scrollbars on mobile */
        }

        canvas {
          display: block;
          margin: 0 auto;
          background: #111;
        }
    </style>
</head>

<body>
<script>
    /****************************************
     *   SNAKE GAME - Two Levels
     ****************************************/

    let cellSize = 40;
    let snake = [];
    let snakeDir = "RIGHT";
    let touchStartX = 0;
    let touchStartY = 0;
    let videoWin; // Video for final win
    let videoLevel1; // Video after finishing level 1
    let videoLose; // Video for game over
    let touchEndX = 0;
    let touchEndY = 0;
    let swipeThreshold = 30; // Min distance for swipe
    let ghostPos;
    let ghostImage;
    let gameOver = false;
    let gameState = "MENU"; // possible states: MENU, PLAYING, LEVEL_TRANSITION, WIN_SCREEN, GAME_OVER
    let level = 2; // Start at level 2 for demonstration? or 1. Modify as needed
    let score = 0;
    let maxScorePerLevel = 12;
    let totalLevels = 2;
    let collectedItems = []; // list of eaten items
    let snakeHeadImage, backgroundImage, winImage;
    let ghostImages = [];
    let eatSounds = [];
    let eatenFoodEffects = [];
    let moveDelay = 10; // move snake only every X frames

    // We will calculate canvas size in setup to handle different screens
    let width = 0;
    let height = 0;

    let snakeBodyImages = [];

    function onCanPlay() {
      this.elt.addEventListener("canplaythrough", () => {
        console.log(`${this.elt.src} is ready to play!`);
      });
    }

    function preload() {
      snakeHeadImage = loadImage("assets/face.png");
      backgroundImage = loadImage("assets/background.png");
      winImage = loadImage("assets/win_image.png");

      // Create & mute videos (they can autoplay if muted, but
      // to avoid AbortError, we won't call .play() automatically)
      videoWin = createVideo("assets/win_video.mp4", onCanPlay);
      videoWin.hide();
      videoWin.volume(0); // Mute

      videoLevel1 = createVideo("assets/win_video2.mp4", onCanPlay);
      videoLevel1.hide();
      videoLevel1.volume(0); // Mute

      videoLose = createVideo("assets/lose_video.mp4", onCanPlay);
      videoLose.hide();
      videoLose.volume(0); // Mute

      // Load other assets
      ghostImages = [
        loadImage("assets/miso.png"),
        loadImage("assets/mold.png"),
        loadImage("assets/frisbee.png"),
        loadImage("assets/car.png"),
        loadImage("assets/gamba.png"),
        loadImage("assets/floor.png"),
        loadImage("assets/rest.png"),
        loadImage("assets/tavor.png"),
        loadImage("assets/rest2.png"),
        loadImage("assets/india.png"),
      ];

      snakeBodyImages = [
        loadImage("assets/snake_body1.png"),
        loadImage("assets/snake_body2.png"),
      ];

      // Example: we only have 1 eat sound in your assets, so let's just push it multiple times or once
      // If you truly have many sounds, adapt accordingly
      for (let i = 1; i <= 3; i++) {
        let soundFile = loadSound(`assets/eat_sound.mp3`);
        eatSounds.push(soundFile);
      }
    }

    function setup() {
      // Calculate dynamic width & height
      width = window.innerWidth * 0.9;
      height = window.innerHeight * 0.9;

      createCanvas(width, height);
      frameRate(30);

      // Touch handling
      document.addEventListener(
        "touchstart",
        (event) => {
          event.preventDefault();
          handleTouchClick(event);
        },
        { passive: false }
      );
      document.addEventListener("click", handleTouchClick, false);

      resetGame();
    }

    function handleTouchClick(event) {
      let x = event.clientX || event.touches?.[0]?.clientX;
      let y = event.clientY || event.touches?.[0]?.clientY;

      // Simple directional check based on location of tap
      if (x > width * 0.66 && snakeDir !== "LEFT") {
        snakeDir = "RIGHT";
      } else if (x < width * 0.33 && snakeDir !== "RIGHT") {
        snakeDir = "LEFT";
      } else if (y < height * 0.33 && snakeDir !== "DOWN") {
        snakeDir = "UP";
      } else if (y > height * 0.66 && snakeDir !== "UP") {
        snakeDir = "DOWN";
      }
    }

    // For swipe
    function handleTouchStart(event) {
      touchStartX = event.touches[0].clientX;
      touchStartY = event.touches[0].clientY;
    }

    function handleTouchEnd(event) {
      touchEndX = event.changedTouches[0].clientX;
      touchEndY = event.changedTouches[0].clientY;

      let diffX = touchEndX - touchStartX;
      let diffY = touchEndY - touchStartY;

      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > swipeThreshold) {
        if (diffX > 0 && snakeDir !== "LEFT") snakeDir = "RIGHT"; // Swipe Right
        else if (diffX < 0 && snakeDir !== "RIGHT") snakeDir = "LEFT"; // Swipe Left
      } else if (Math.abs(diffY) > swipeThreshold) {
        if (diffY > 0 && snakeDir !== "UP") snakeDir = "DOWN"; // Swipe Down
        else if (diffY < 0 && snakeDir !== "DOWN") snakeDir = "UP"; // Swipe Up
      }
    }

    function draw() {
      if (gameState === "MENU") {
        drawMenu();
        return;
      }
      if (gameState === "LEVEL_TRANSITION") {
        drawLevelTransition();
        return;
      }
      if (gameState === "WIN_SCREEN") {
        drawWinScreen();
        return;
      }
      if (gameOver) {
        drawGameOver();
        return;
      }

      background(backgroundImage);
      drawSnake();
      drawGhost();
      animateEatenFood();
      drawScore();

      // Move the snake only every "moveDelay" frames
      if (frameCount % moveDelay === 0) {
        moveSnake();
      }
    }

    /****************************************
     *   STATE SCREENS
     ****************************************/
    function drawMenu() {
      background(15, 23, 42);
      textAlign(CENTER, CENTER);

      let sectionHeight = height / 3;
      let imageSize = width * 0.15;

      // Part 1: "YOU"
      fill(255);
      textSize(width * 0.07);
      text("YOU", width / 2, sectionHeight * 0.25);

      // Show snake head + body
      image(
        snakeHeadImage,
        width / 2 - imageSize - 10,
        sectionHeight * 0.4,
        imageSize,
        imageSize
      );
      image(
        snakeBodyImages[1],
        width / 2 + 10,
        sectionHeight * 0.4,
        imageSize,
        imageSize
      );

      // Part 2: "FOOD"
      fill(255);
      text("FOOD", width / 2, sectionHeight + sectionHeight * 0.25);

      let foodStartY = sectionHeight + sectionHeight * 0.4;
      let cols = 4;
      let spacing = width * 0.18;

      for (let i = 0; i < ghostImages.length; i++) {
        let x = (i % cols) * spacing + (width / 2 - ((cols - 1) * spacing) / 2);
        let y = foodStartY + Math.floor(i / cols) * spacing;
        image(ghostImages[i], x, y, imageSize, imageSize);
      }

      // Part 3: "SURVIVE!" button
      let btnWidth = width * 0.6;
      let btnHeight = sectionHeight * 0.6;
      let btnX = width / 2 - btnWidth / 2;
      let btnY = sectionHeight * 2 + sectionHeight * 0.2;

      fill(0, 255, 153);
      rect(btnX, btnY, btnWidth, btnHeight, 15);
      fill(0);
      textSize(width * 0.07);
      text("SURVIVE!", width / 2, btnY + btnHeight / 2);
    }

    function drawLevelTransition() {
      background(0);
      textAlign(CENTER, CENTER);
      fill(255);
      textSize(width * 0.07);
      text(`You survived 1 year!`, width / 2, height * 0.2);

      // Show the video but do NOT autoplay
      videoLevel1.position(width * 0.1, height * 0.3);
      videoLevel1.size(width * 0.8, height * 0.4);
      videoLevel1.show();

      // Button to play the video
      let btnPlayWidth = width * 0.6;
      let btnPlayHeight = height * 0.08;
      let btnPlayX = width / 2 - btnPlayWidth / 2;
      let btnPlayY = height * 0.45;

      fill(0, 255, 0);
      rect(btnPlayX, btnPlayY, btnPlayWidth, btnPlayHeight, 15);
      fill(0);
      textSize(width * 0.05);
      text("Play Video", width / 2, btnPlayY + btnPlayHeight / 2);

      // Button to continue to year 2
      let btnWidth = width * 0.6;
      let btnHeight = height * 0.08;
      let btnX = width / 2 - btnWidth / 2;
      let btnY = height * 0.75;

      fill(255, 128, 0);
      rect(btnX, btnY, btnWidth, btnHeight, 15);
      fill(0);
      textSize(width * 0.05);
      text("Continue to Year 2", width / 2, btnY + btnHeight / 2);
    }

    function drawWinScreen() {
      background(0);
      textAlign(CENTER, CENTER);
      textSize(width * 0.07);
      fill(255);
      text("You survived 2 years!", width / 2, height * 0.2);

      // Show the video but do NOT autoplay
      videoWin.position(width * 0.1, height * 0.3);
      videoWin.size(width * 0.8, height * 0.4);
      videoWin.show();

      // Add play button
      let btnWidth = width * 0.6;
      let btnHeight = height * 0.08;
      let btnX = width / 2 - btnWidth / 2;
      let btnY = height * 0.5;

      fill(0, 255, 0);
      rect(btnX, btnY, btnWidth, btnHeight, 15);
      fill(0);
      textSize(width * 0.05);
      text("Play Video", width / 2, btnY + btnHeight / 2);
    }

    function drawGameOver() {
      background(0);
      textAlign(CENTER, CENTER);

      fill(255);
      textSize(width * 0.07);
      text("Game Over!", width / 2, height * 0.2);

      // Show the video but do NOT autoplay
      videoLose.position(width * 0.1, height * 0.3);
      videoLose.size(width * 0.8, height * 0.4);
      videoLose.show();

      // Add button to play the video
      let btnPlayWidth = width * 0.6;
      let btnPlayHeight = height * 0.08;
      let btnPlayX = width / 2 - btnPlayWidth / 2;
      let btnPlayY = height * 0.45;

      fill(0, 255, 255);
      rect(btnPlayX, btnPlayY, btnPlayWidth, btnPlayHeight, 15);
      fill(0);
      textSize(width * 0.05);
      text("Play Video", width / 2, btnPlayY + btnPlayHeight / 2);

      // Button Restart
      let btnWidth = width * 0.6;
      let btnHeight = height * 0.08;
      let btnX = width / 2 - btnWidth / 2;
      let btnY = height * 0.75;

      fill(255, 0, 0);
      rect(btnX, btnY, btnWidth, btnHeight, 15);
      fill(0);
      textSize(width * 0.05);
      text("Restart", width / 2, btnY + btnHeight / 2);
    }

    /****************************************
     *   GAME LOGIC
     ****************************************/
    function moveSnake() {
      let head = [...snake[0]];
      if (snakeDir === "UP") head[1] -= cellSize;
      if (snakeDir === "DOWN") head[1] += cellSize;
      if (snakeDir === "LEFT") head[0] -= cellSize;
      if (snakeDir === "RIGHT") head[0] += cellSize;

      // Wrap around
      head[0] = (head[0] + width) % width;
      head[1] = (head[1] + height) % height;

      // Check collision with itself
      if (snake.some((segment) => segment[0] === head[0] && segment[1] === head[1])) {
        gameOver = true;
        gameState = "GAME_OVER";
        return;
      }

      snake.unshift(head);

      // Check eating ghost
      if (dist(head[0], head[1], ghostPos[0], ghostPos[1]) < cellSize) {
        score++;
        collectedItems.push(ghostImage);

        eatenFoodEffects.push({
          x: ghostPos[0],
          y: ghostPos[1],
          size: cellSize * 2, // start bigger
          opacity: 255,
          image: ghostImage,
        });

        spawnNewGhost();
        playRandomEatSound();

        // Check if level complete
        if (score === maxScorePerLevel) {
          if (level === 1) {
            gameState = "LEVEL_TRANSITION";
          } else if (level === 2) {
            gameState = "WIN_SCREEN";
            // We only SHOW video here, do not automatically play it.
          }
        }
      } else {
        // No eat => remove tail
        snake.pop();
      }
    }

    function animateEatenFood() {
      for (let i = eatenFoodEffects.length - 1; i >= 0; i--) {
        let food = eatenFoodEffects[i];
        // expand & fade out
        food.size += 2;
        food.opacity -= 15;

        tint(255, food.opacity);
        image(food.image, food.x, food.y, food.size, food.size);
        noTint();

        if (food.opacity <= 0) {
          eatenFoodEffects.splice(i, 1);
        }
      }
    }

    /****************************************
     *   INPUT HANDLERS
     ****************************************/
    function keyPressed() {
      if (keyCode === UP_ARROW && snakeDir !== "DOWN") snakeDir = "UP";
      if (keyCode === DOWN_ARROW && snakeDir !== "UP") snakeDir = "DOWN";
      if (keyCode === LEFT_ARROW && snakeDir !== "RIGHT") snakeDir = "LEFT";
      if (keyCode === RIGHT_ARROW && snakeDir !== "LEFT") snakeDir = "RIGHT";

      // Quick keys for debugging
      if (key === "R" || key === "r") resetGame();
      if (key === "M" || key === "m") gameState = "MENU"; // back to menu
    }

    function mousePressed() {
      // Handle "WIN_SCREEN" button (Play Video)
      if (gameState === "WIN_SCREEN") {
        let btnWidth = width * 0.6;
        let btnHeight = height * 0.08;
        let btnX = width / 2 - btnWidth / 2;
        let btnY = height * 0.5;

        // If user clicks the "Play Video" button
        if (
          mouseX > btnX &&
          mouseX < btnX + btnWidth &&
          mouseY > btnY &&
          mouseY < btnY + btnHeight
        ) {
          videoWin.play();
        }
      }

      // Handle "MENU" (SURVIVE button)
      if (gameState === "MENU") {
        let btnWidth = width * 0.6;
        let btnHeight = (height / 3) * 0.6;
        let btnX = width / 2 - btnWidth / 2;
        let btnY = (height / 3) * 2 + (height / 3) * 0.2;

        if (
          mouseX > btnX &&
          mouseX < btnX + btnWidth &&
          mouseY > btnY &&
          mouseY < btnY + btnHeight
        ) {
          gameState = "PLAYING";
          resetGame();
        }
      }

      // Handle "GAME_OVER": "Play Video" & "Restart"
      if (gameState === "GAME_OVER") {
        // "Play Video" button
        let btnPlayWidth = width * 0.6;
        let btnPlayHeight = height * 0.08;
        let btnPlayX = width / 2 - btnPlayWidth / 2;
        let btnPlayY = height * 0.45;

        if (
          mouseX > btnPlayX &&
          mouseX < btnPlayX + btnPlayWidth &&
          mouseY > btnPlayY &&
          mouseY < btnPlayY + btnPlayHeight
        ) {
          videoLose.play();
        }

        // "Restart" button
        let btnWidth = width * 0.6;
        let btnHeight = height * 0.08;
        let btnX = width / 2 - btnWidth / 2;
        let btnY = height * 0.75;

        if (
          mouseX > btnX &&
          mouseX < btnX + btnWidth &&
          mouseY > btnY &&
          mouseY < btnY + btnHeight
        ) {
          videoLose.stop();
          videoLose.hide();
          gameState = "PLAYING";
          resetGame();
        }
      }

      // Handle "LEVEL_TRANSITION": "Play Video" & "Continue"
      if (gameState === "LEVEL_TRANSITION") {
        // "Play Video" button
        let btnPlayWidth = width * 0.6;
        let btnPlayHeight = height * 0.08;
        let btnPlayX = width / 2 - btnPlayWidth / 2;
        let btnPlayY = height * 0.45;

        if (
          mouseX > btnPlayX &&
          mouseX < btnPlayX + btnPlayWidth &&
          mouseY > btnPlayY &&
          mouseY < btnPlayY + btnPlayHeight
        ) {
          videoLevel1.play();
        }

        // "Continue to Year 2" button
        let btnWidth = width * 0.6;
        let btnHeight = height * 0.08;
        let btnX = width / 2 - btnWidth / 2;
        let btnY = height * 0.75;

        if (
          mouseX > btnX &&
          mouseX < btnX + btnWidth &&
          mouseY > btnY &&
          mouseY < btnY + btnHeight
        ) {
          videoLevel1.stop();
          videoLevel1.hide();
          level = 2;
          score = 0;
          gameState = "PLAYING";
          resetGame();
        }
      }
    }

    /****************************************
     *   HELPERS
     ****************************************/
    function resetGame() {
      snake = [
        [100, 50],
        [60, 50],
        [20, 50],
      ];
      snakeDir = "RIGHT";
      score = 0;
      gameOver = false;

      // If starting level 2, do that here, else default
      if (gameState === "PLAYING" && level === 2) {
        console.log("Starting Level 2!");
      }

      spawnNewGhost();
    }

    function spawnNewGhost() {
      ghostPos = randomGhostPosition();
      ghostImage = random(ghostImages);
    }

    function drawGhost() {
      let foodSize = cellSize * 1.5; // 50% bigger
      let offset = (foodSize - cellSize) / 2;
      image(
        ghostImage,
        ghostPos[0] - offset,
        ghostPos[1] - offset,
        foodSize,
        foodSize
      );
    }

    function playRandomEatSound() {
      if (eatSounds.length > 0) {
        let sound = random(eatSounds);
        sound.play();
      }
    }

    function randomGhostPosition() {
      let cols = floor(width / cellSize);
      let rows = floor(height / cellSize);
      let x = floor(random(cols)) * cellSize;
      let y = floor(random(rows)) * cellSize;
      return [x, y];
    }

    function drawSnake() {
      for (let i = 0; i < snake.length; i++) {
        if (i === 0) {
          // head
          image(snakeHeadImage, snake[i][0], snake[i][1], cellSize, cellSize);
        } else {
          // body
          let bodyImage = snakeBodyImages[i % 2];
          image(bodyImage, snake[i][0], snake[i][1], cellSize, cellSize);
        }
      }
    }

    function drawScore() {
      let padding = width * 0.03;
      let boxHeight = height * 0.05;
      let textSizeValue = width * 0.045;

      // background behind the text
      fill(0, 0, 0, 150);
      rect(padding, padding, width * 0.35, boxHeight, 8);
      rect(width - width * 0.35 - padding, padding, width * 0.35, boxHeight, 8);

      fill(255);
      textSize(textSizeValue);
      textAlign(LEFT, CENTER);
      text(`Score: ${score}`, padding + 10, padding + boxHeight / 2);

      textAlign(RIGHT, CENTER);
      text(`Level: ${level}`, width - padding - 10, padding + boxHeight / 2);
    }
</script>
</body>
</html>
